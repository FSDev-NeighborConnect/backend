# Neighborhood Connect

> This documentation covers the **backend API and server infrastructure** for the Neighborhood Connect project, developed as part of the course *Fullstack Development DA219B*.  
>
> The frontend (React) is maintained separately: [Frontend repository](https://github.com/FSDev-NeighborConnect/frontend).  
>
> This backend repository includes:
> - All API routes and controllers
> - Mongoose models and database integration
> - Middleware for authentication, CSRF and validation
> - Cloudinary image hosting configuration
> - Other core server functionality

## Overview

Neighborhood Connect is a fullstack platform that empowers neighbors to offer or request help, post local tasks, comment and interact securely within their communities.

## Technologies

- **Backend**: Node.js, Express
- **Database**: MongoDB (Mongoose)
- **Authentication**: JWT (HTTP-only cookies), CSRF protection
- **Image Hosting**: Cloudinary
- **Testing**: Jest, Supertest (~90% test coverage)
- **Documentation**: Swagger UI

## Project Structure

```
backend/
├── config/            # MongoDB and Cloudinary configuration
├── controllers/       # Request logic (user, post, auth, etc)
├── middleware/        # Auth, validation, CSRF, error handling
├── models/            # Mongoose schemas for MongoDB
├── routes/            # Express route definitions
├── services/          # Auth helpers (JWT, CSRF, cookies)
├── utils/             # Cloudinary, hashing, sanitization, validation
├── tests/             # Unit and integration testing
├── server.js          # App entry point
└── .env.example       # Sample environment config
```

## Setup Instructions

1. Clone the repository:
   ```bash
   git clone https://github.com/FSDev-NeighborConnect/backend.git
   
   cd backend
   ```

2. Install dependencies:
   ```bash
   npm install
   ```

3. Create a `.env` file based on the provided example:

    Copy the `.env.example` file and rename the copy to `.env`.

4. Start the development server:
   ```bash
   npm run dev
   ```

5. Run tests with coverage:
   ```bash
   npm run test:coverage
   ```

## Environment Variables

| Variable                    | Description                                               |
|-----------------------------|-----------------------------------------------------------|
| `PORT`                      | Port to run the server (default: `3000`)                  |
| `CONNECTION_URL`           | MongoDB connection string (local instance or Atlas URI)            |
| `JWT_SECRET`                | Secret key used to sign and verify JWTs                  |
| `CLOUDINARY_CLOUD_NAME`     | Cloudinary cloud name                                     |
| `CLOUDINARY_API_KEY`        | Cloudinary API key                                        |
| `CLOUDINARY_API_SECRET`     | Cloudinary API secret                                     |
| `FRONTEND_URL`              | Frontend deployment origin URL for CORS (production)                 |
| `FRONTEND_DEVPREVIEW_URL`   | Alternate frontend dev preview origin (optional for CORS)     |
| `ENABLE_API_DOCS`           | If set (e.g. to `true`), enables `/api-docs` route        |

## Test Coverage

> Generated by Jest using `npm run test:coverage` (Jest + Supertest)

- **Statements**: 89.55%  
- **Branches**:   84.35%  
- **Functions**:  89.18%  
- **Lines**:      89.86%

> The test suite includes **106 passing tests** across **12 test suites**.

## Key Features

- User registration and login with secure JWT cookie authentication
- CSRF protection for all state-changing requests
- Post creation, deletion and filtering by ZIP code
- Commenting on and liking posts
- Admin role with full CRUD and moderation privileges across users, posts, comments and events
- User avatar, cover and event image hosting via Cloudinary

## Authentication Flow

1. Upon login, the server returns:
   - A **JWT** stored in an HTTP-only cookie, which includes an embedded CSRF token
   - The same **CSRF token** in the response body which the client then stores
2. All protected requests must include:
   - `Cookie` (automatically sent by the browser)
   - `X-CSRF-Token` (manually added by the client using the token from login)
3. Middleware:
   - Verifies the JWT and extracts the embedded CSRF token
   - Compares it against the `X-CSRF-Token` header to validate the request


## Documentation

This project uses [`swagger-ui-express`](https://www.npmjs.com/package/swagger-ui-express) to serve live API documentation based on OpenAPI 3.0 specification.

- The OpenAPI specification is written and maintained in `swagger.yaml`
- Swagger UI renders the specification at runtime, available at [`/api-docs`](http://localhost:3000/api-docs)
- This allows interactive testing, schema browsing and endpoint discovery


## API Overview
> For interactive API reference, visit: [`/api-docs`](http://localhost:3000/api-docs)

### Authentication

- `POST /api/signup` – Register user
- `POST /api/login` – User login
- `POST /api/logout` – User logout

### Users

- `GET /api/users/user/:id` – Get public user info
- `PUT /api/users/:id` – Update own profile
- `DELETE /api/users/:id` – Delete own profile
- `GET /api/users/currentUser` – Get current logged-in user
- `GET /api/users/me` – Get current logged-in user (used by chat functionality)
- `GET /api/users/zip/:zip` – Filter users by ZIP
- `GET /api/users/all` – Get all users (publicly safe data only)
- `POST /api/users/upload-avatar` – Upload avatar
- `POST /api/users/upload-cover` – Upload cover

### Posts

- `GET /api/posts/all/posts` – All posts
- `GET /api/posts/:id` – Post by ID
- `POST /api/posts/post` – Create post
- `DELETE /api/posts/:id` – Delete post
- `GET /api/posts/user/:id` – User's posts
- `GET /api/posts/zip` – Posts by ZIP

#### Likes

- `POST /api/posts/:id/like` – Like/unlike post
- `GET /api/posts/likes/:id` – Like count

#### Comments

- `GET /api/posts/:postId/comments` – All comments for post
- `POST /api/posts/:postId/comments` – Add comment
- `DELETE /api/posts/:postId/comments/:id` – Delete comment

### Events

- `POST /api/events/event` – Create a new event (supports image upload)
- `GET /api/events/zip` – Get events filtered by ZIP code
- `GET /api/events/user/:id` – Get events created by a specific user
- `GET /api/events/:id` – Get event by ID
- `POST /api/events/:id/like` – Like or unlike an event
- `DELETE /api/events/:id` – Delete an event
- `POST /api/events/events/:eventId/rsvp` – RSVP to an event

### Admin

- `POST /api/admin/login` – Admin login
- `GET /api/admin/all/users` – View all users
- `POST /api/admin/users/create` – Create a new user
- `DELETE /api/admin/users/:id` – Delete user
- `PUT /api/admin/users/:id` – Update user
- `GET /api/admin/all/posts` – View all posts
- `DELETE /api/admin/posts/:id` – Delete post
- `PUT /api/admin/posts/:id` – Update post
- `GET /api/admin/all/events` – View all events
- `DELETE /api/admin/events/:id` – Delete event
- `PUT /api/admin/events/:id` – Update event
- `GET /api/admin/all/comments` – View comments
- `DELETE /api/admin/comments/:id` – Delete comment

## License

This project is licensed under the [Apache License 2.0](./LICENSE).

## Contributors

- [Elias Daoud](https://github.com/Rad-Vega)
- [Meenu Gupta](https://github.com/findmeenu)